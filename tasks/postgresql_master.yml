- name: ensure postfix dirs
  file:
    state: directory
    dest: "{{ item }}"
    owner: "{{ postgres_user }}"
    group: "{{ postgres_group }}"
    mode: 0755
  with_items:
    - "{{ postgres_datadir }}"
    - "{{ postgres_confdir }}"
- name: enable systemd service
  template:
    src: pgservice.j2
    dest: /usr/lib/systemd/system/postgresql.service

- name: enable postgresql
  systemd:
    name: postgresql
    state: stopped
    daemon_reload: yes
    enabled: yes

- name: remove rpm service file
  file:
    state: absent
    dest: /usr/lib/systemd/system/postgresql-{{ postgres_version }}.service

- name: initialize database
  command: "/usr/pgsql-{{ postgres_version }}/bin/initdb --pgdata={{ postgres_datadir }}/{{ postgres_version }}/data/"
  args:
    creates: "{{ postgres_datadir }}/{{ postgres_version }}/data/PG_VERSION"
  become_user: "{{ postgres_user }}"
  
- name: enable postgresql
  systemd:
    name: postgresql
    state: started
    daemon_reload: yes
    enabled: yes 

- name: create replication user
  postgresql_user:
    state: present
    name: "{{ postgres_replication_user }}"
    password: "{{ postgres_replication_user_pass }}"
    role_attr_flags: LOGIN,REPLICATION
    ssl_mode: disable
  become_user: "{{ postgres_user }}"
